<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="deo, Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="专业救火，专职刷脸，价格公道，值得拥有">
<meta property="og:type" content="website">
<meta property="og:title" content="Deo">
<meta property="og:url" content="http://deo.im/index.html">
<meta property="og:site_name" content="Deo">
<meta property="og:description" content="专业救火，专职刷脸，价格公道，值得拥有">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Deo">
<meta name="twitter:description" content="专业救火，专职刷脸，价格公道，值得拥有">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://deo.im/"/>

  <title> Deo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?31e0a1005e6f51872dbea652698aeb8c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Deo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Deo's Tech Blog</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/23/Using-scikit-learn-in-Celery/" itemprop="url">
                  Using scikit-learn in Celery
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-23T08:46:00+08:00" content="2016-09-23">
              2016-09-23
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/23/Using-scikit-learn-in-Celery/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/23/Using-scikit-learn-in-Celery/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/23/Using-scikit-learn-in-Celery/" class="leancloud_visitors" data-flag-title="Using scikit-learn in Celery">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.celeryproject.org/" target="_blank" rel="external">Celery</a> is great if you want to distribute your tasks into multi processes/machines.</p>
<p>However if you use Python’s multiprocess with a Celery task, you may probably encounter:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">raised unexpected: AttributeError(<span class="string">"'Worker' object has no attribute '_config'"</span>,)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"/Users/.../.virtualenvs/mdt-dev/lib/python3.5/site-packages/celery/app/trace.py"</span>, line 240, <span class="keyword">in</span> trace_task</div><div class="line">    R = retval = fun(*args, **kwargs)</div><div class="line">  File <span class="string">"/Users/.../.virtualenvs/mdt-dev/lib/python3.5/site-packages/celery/app/trace.py"</span>, line 438, <span class="keyword">in</span> __protected_call__</div><div class="line">    <span class="built_in">return</span> self.run(*args, **kwargs)</div><div class="line">  File <span class="string">"/Users/.../pyproj/modeling/tasks/miscellaneous.py"</span>, line 29, <span class="keyword">in</span> predict_house_type</div><div class="line">    clf = pickle.loads(f.read())</div><div class="line">  File <span class="string">"/Users/.../.virtualenvs/mdt-dev/lib/python3.5/site-packages/sklearn/__init__.py"</span>, line 57, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from .base import <span class="built_in">clone</span></div><div class="line">  File <span class="string">"/Users/.../.virtualenvs/mdt-dev/lib/python3.5/site-packages/sklearn/base.py"</span>, line 11, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from .utils.fixes import signature</div><div class="line">  File <span class="string">"/Users/.../.virtualenvs/mdt-dev/lib/python3.5/site-packages/sklearn/utils/__init__.py"</span>, line 17, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from ..externals.joblib import cpu_count</div><div class="line">  File <span class="string">"/Users/.../.virtualenvs/mdt-dev/lib/python3.5/site-packages/sklearn/externals/joblib/__init__.py"</span>, line 127, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from .parallel import Parallel</div><div class="line">  File <span class="string">"/Users/.../.virtualenvs/mdt-dev/lib/python3.5/site-packages/sklearn/externals/joblib/parallel.py"</span>, line 25, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    from ._multiprocessing_helpers import mp</div><div class="line">  File <span class="string">"/Users/liangdeo/.virtualenvs/mdt-dev/lib/python3.5/site-packages/sklearn/externals/joblib/_multiprocessing_helpers.py"</span>, line 25, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    _sem = mp.Semaphore()</div><div class="line">  File <span class="string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/multiprocessing/context.py"</span>, line 81, <span class="keyword">in</span> Semaphore</div><div class="line">    <span class="built_in">return</span> Semaphore(value, ctx=self.get_context())</div><div class="line">  File <span class="string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/multiprocessing/synchronize.py"</span>, line 127, <span class="keyword">in</span> __init__</div><div class="line">    SemLock.__init__(self, SEMAPHORE, value, SEM_VALUE_MAX, ctx=ctx)</div><div class="line">  File <span class="string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/multiprocessing/synchronize.py"</span>, line 59, <span class="keyword">in</span> __init__</div><div class="line">    kind, value, maxvalue, self._make_name(),</div><div class="line">  File <span class="string">"/usr/local/Cellar/python3/3.5.1/Frameworks/Python.framework/Versions/3.5/lib/python3.5/multiprocessing/synchronize.py"</span>, line 117, <span class="keyword">in</span> _make_name</div><div class="line">    <span class="built_in">return</span> <span class="string">'%s-%s'</span> % (process.current_process()._config[<span class="string">'semprefix'</span>],</div><div class="line">AttributeError: <span class="string">'Worker'</span> object has no attribute <span class="string">'_config'</span></div></pre></td></tr></table></figure></p>
<p>It’s a known issue that Celery doesn’t support multiprocess well in task <a href="https://github.com/celery/billiard/issues/168" target="_blank" rel="external">issue</a>. One solution will be to refactorize your code to avoid using multiprocess, since you already have Celery to do it for you.</p>
<p>However if you are using libries lick scikit-learn, ntlk which use multiprocess underneath, you may try the following to workaround it:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># some_task.py</span></div><div class="line"><span class="keyword">from</span> celery.signals <span class="keyword">import</span> worker_process_init</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@worker_process_init.connect</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fix_multiprocessing</span><span class="params">(**_)</span>:</span></div><div class="line">  <span class="keyword">from</span> multiprocessing <span class="keyword">import</span> current_process</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    current_process()._config</div><div class="line">  <span class="keyword">except</span> AttributeError:</div><div class="line">    current_process()._config = &#123;<span class="string">'semprefix'</span>: <span class="string">'/mp'</span>&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/22/Load-data-from-mongodb-to-Pandas-DataFrame/" itemprop="url">
                  Load data from MongoDB to Pandas DataFrame
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-22T08:30:00+08:00" content="2016-09-22">
              2016-09-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/22/Load-data-from-mongodb-to-Pandas-DataFrame/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/22/Load-data-from-mongodb-to-Pandas-DataFrame/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/22/Load-data-from-mongodb-to-Pandas-DataFrame/" class="leancloud_visitors" data-flag-title="Load data from MongoDB to Pandas DataFrame">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.mongodb.com/" target="_blank" rel="external">MongoDB</a> is a great document database for non-determined number or structure of fields yet separatable records.</p>
<p>We use it to store our intermediate level of data ( which is a little bit cleaner than the raw but not production ready) for model training. So there comes a question of how to load data from MongoDB collections to python pandas.DataFrame</p>
<p>Supposed your are using pymongo to read:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pymongo</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"></div><div class="line"><span class="keyword">with</span> pymongo.MongoClient(<span class="string">'mongodb://user:password@localhost:port/mydb'</span>) <span class="keyword">as</span> client:</div><div class="line">  collection = client.get_default_databasedb[<span class="string">'my collection'</span>]</div><div class="line">  data = pd.DataFrame(list(collection.find()))</div></pre></td></tr></table></figure></p>
<p>This is quick and easy for small collection, yet it creates problems when one is big, the <strong>list</strong> function read all data from the cursor iterator of dictionaries into memory. So a slightly modification could help to maintain a low memory consumption (trade off a bit of performance):<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">iterator2dataframes</span><span class="params">(iterator, chunk_size: int)</span>:</span></div><div class="line">  <span class="string">"""Turn an iterator into multiple small pandas.DataFrame</span></div><div class="line"></div><div class="line">  This is a balance between memory and efficiency</div><div class="line">  """</div><div class="line">  records = []</div><div class="line">  frames = []</div><div class="line">  <span class="keyword">for</span> i, record <span class="keyword">in</span> enumerate(iterator):</div><div class="line">    records.append(record)</div><div class="line">    <span class="keyword">if</span> i % chunk_size == chunk_size - <span class="number">1</span>:</div><div class="line">      frames.append(pd.DataFrame(records))</div><div class="line">      records = []</div><div class="line">  <span class="keyword">if</span> records:</div><div class="line">    frames.append(pd.DataFrame(records))</div><div class="line">  <span class="keyword">return</span> pd.concat(frames) <span class="keyword">if</span> frames <span class="keyword">else</span> pd.DataFrame()</div><div class="line">  </div><div class="line">data = iterator2dataframe(collection.find(), <span class="number">10000</span>)</div></pre></td></tr></table></figure></p>
<p>If by chance you need to generate multiple DataFrame rows for each mongodb document (additional support of progress bar with tqdm):<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">iterator2dataframe</span><span class="params">(iterator,</span></span></div><div class="line">                       chunk_size: int,</div><div class="line">                       func=None,</div><div class="line">                       **kwargs) -&gt; pd.DataFrame:</div><div class="line">  <span class="string">"""Turn an Mongo iterator into multiple small pandas.DataFrame</span></div><div class="line"></div><div class="line">  This is a balance between memory and efficiency</div><div class="line">  If no result, return empty pandas.DataFrame</div><div class="line">  Args:</div><div class="line">    iterator: an iterator</div><div class="line">    chunk_size: the row size of each small pandas.DataFrame</div><div class="line">    func: generator to transform each record</div><div class="line">    kwargs: extra parameters passed to tqdm.tqdm</div><div class="line">  Returns:</div><div class="line">    pandas.DataFrame</div><div class="line">  """</div><div class="line">  records = []</div><div class="line">  frames = []</div><div class="line">  <span class="keyword">for</span> i, record <span class="keyword">in</span> enumerate(tqdm(iterator, **kwargs)):</div><div class="line">    <span class="keyword">if</span> func:</div><div class="line">      <span class="keyword">for</span> new_record <span class="keyword">in</span> func(record):</div><div class="line">        records.append(new_record)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      records.append(record)</div><div class="line">    <span class="keyword">if</span> i % chunk_size == chunk_size - <span class="number">1</span>:</div><div class="line">      frames.append(pd.DataFrame(records))</div><div class="line">      records = []</div><div class="line">  <span class="keyword">if</span> records:</div><div class="line">    frames.append(pd.DataFrame(records))</div><div class="line">  <span class="keyword">return</span> pd.concat(frames) <span class="keyword">if</span> frames <span class="keyword">else</span> pd.DataFrame()</div><div class="line">  </div><div class="line"><span class="comment"># func parameter example, must be a Generator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">record_result</span><span class="params">(record)</span>:</span></div><div class="line">  <span class="keyword">for</span> interaction <span class="keyword">in</span> record[<span class="string">'xxx'</span>]:</div><div class="line">  <span class="keyword">yield</span> &#123;</div><div class="line">    <span class="string">'a'</span>: record[<span class="string">'_id'</span>],</div><div class="line">    <span class="string">'b'</span>: interaction[<span class="string">'b'</span>]</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">data = iterator2dataframe(collection.find(), <span class="number">1000</span>, func=record_result)</div></pre></td></tr></table></figure></p>
<p>In fact, pandas.DataFrame support reading a Generator(not Iterator) as input, however the memory management seems to be bad<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># not recommended</span></div><div class="line">pd.DataFrame(<span class="keyword">lambda</span> x: <span class="keyword">yield</span> x <span class="keyword">for</span> x <span class="keyword">in</span> collection.find())</div></pre></td></tr></table></figure></p>
<p>Alternatively, if you are just dumping a collection, you could try <a href="https://odo.readthedocs.io/en/latest/mongo.html" target="_blank" rel="external">odo’s mongo</a>, haven’t really tried it yet, shall do a comparison in the future update.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/21/Adapting-Pandas-data-type-using-Psycopg2/" itemprop="url">
                  Adapting Pandas data type using Psycopg2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-21T08:33:00+08:00" content="2016-09-21">
              2016-09-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/21/Adapting-Pandas-data-type-using-Psycopg2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/21/Adapting-Pandas-data-type-using-Psycopg2/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/21/Adapting-Pandas-data-type-using-Psycopg2/" class="leancloud_visitors" data-flag-title="Adapting Pandas data type using Psycopg2">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>As a data scientist you may probably use Pandas a lot to play with your data.</p>
<p>While it’s quite easy to read data from PostgreSQL combined with Psycopg2:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> psycopg2</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"></div><div class="line"><span class="keyword">with</span> psycopg2.connect(<span class="string">'some dsn'</span>) <span class="keyword">as</span> conn:</div><div class="line">  data = pd.read_sql_query(<span class="string">'your sql'</span>, conn)</div></pre></td></tr></table></figure></p>
<p>but writing the data back to PostgreSQL we need to create some adapters. As the <a href="http://pandas.pydata.org/pandas-docs/stable/basics.html" target="_blank" rel="external">Pandas API doc(scroll down to bottom)</a> shows, you may do:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> psycopg2</div><div class="line"><span class="keyword">from</span> psycopg2 <span class="keyword">import</span> extensions</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_float</span><span class="params">(x)</span>:</span></div><div class="line">  <span class="string">"""psycopg2 interpolation to float"""</span></div><div class="line">  <span class="keyword">return</span> extensions.AsIs(<span class="string">'%f'</span> % float(x))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_int</span><span class="params">(x)</span>:</span></div><div class="line">  <span class="string">"""psycopg2 interpolation to int"""</span></div><div class="line">  <span class="keyword">return</span> extensions.AsIs(<span class="string">'%d'</span> % int(x))</div><div class="line"></div><div class="line">extensions.register_adapter(np.floating, to_float)</div><div class="line">extensions.register_adapter(np.integer, to_int)</div></pre></td></tr></table></figure></p>
<p>Notice we adapt the base type as Pandas internal storing of float/int may be a little different from what you see in ‘dtype’</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/20/Pickle-can-t-dump-2GB-file/" itemprop="url">
                  Pickle can't dump 2GB+ file on MAC OS X
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-20T07:09:00+08:00" content="2016-09-20">
              2016-09-20
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/20/Pickle-can-t-dump-2GB-file/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/20/Pickle-can-t-dump-2GB-file/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/20/Pickle-can-t-dump-2GB-file/" class="leancloud_visitors" data-flag-title="Pickle can't dump 2GB+ file on MAC OS X">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>As a data scientist/engineer you may very likely work with big dataset.</p>
<p>If you’re trying to pickle big files over 2GB, you may encounter this on MAC OS X:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">OSError                                   Traceback (most recent call last)</div><div class="line">&lt;ipython-input-5-5b2910a2f7f4&gt; <span class="keyword">in</span> &lt;module&gt;()</div><div class="line">----&gt; 1 df.to_pickle(<span class="string">'test.pkl'</span>)</div><div class="line"></div><div class="line">/Users/.../lib/python3.5/site-packages/pandas/core/generic.py <span class="keyword">in</span> to_pickle(self, path)</div><div class="line">   1175         <span class="string">""</span><span class="string">"</span></div><div class="line">   1176         from pandas.io.pickle import to_pickle</div><div class="line">-&gt; 1177         return to_pickle(self, path)</div><div class="line">   1178</div><div class="line">   1179     def to_clipboard(self, excel=None, sep=None, **kwargs):</div><div class="line"></div><div class="line">/Users/.../lib/python3.5/site-packages/pandas/io/pickle.py in to_pickle(obj, path)</div><div class="line">     18     "<span class="string">""</span></div><div class="line">     19     with open(path, <span class="string">'wb'</span>) as f:</div><div class="line">---&gt; 20         pkl.dump(obj, f, protocol=pkl.HIGHEST_PROTOCOL)</div><div class="line">     21</div><div class="line">     22</div><div class="line"></div><div class="line">OSError: [Errno 22] Invalid argument</div></pre></td></tr></table></figure></p>
<p>This has been a long reported issue over a year, as you can find in <a href="http://bugs.python.org/issue24658" target="_blank" rel="external">Issue 24658</a>, not exactly pickle related though.</p>
<p>Fortunately it’s fixed now but may need some time before release, one can either:</p>
<ol>
<li>patch the fix</li>
<li>just split the target file to 2GB-</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/19/Install-gdal-2-1-on-Mac-OS-X/" itemprop="url">
                  Install gdal 2.1 on Mac OS X
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-19T07:50:00+08:00" content="2016-09-19">
              2016-09-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/19/Install-gdal-2-1-on-Mac-OS-X/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/19/Install-gdal-2-1-on-Mac-OS-X/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/19/Install-gdal-2-1-on-Mac-OS-X/" class="leancloud_visitors" data-flag-title="Install gdal 2.1 on Mac OS X">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://gdal.org/" target="_blank" rel="external">GDAL</a> is a great library of your need if you’re working with GEO data.</p>
<p>On Mac OS X, To install it, simply type:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install gdal</div></pre></td></tr></table></figure></p>
<p>will install the 1.3 version for you, if you need to newest 2.1+ version, try the following:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install https://raw.githubusercontent.com/OSGeo/homebrew-osgeo4mac/master/Formula/gdal-20.rb</div></pre></td></tr></table></figure></p>
<p>For more details or when it doesn’t work, have a look at their <a href="https://github.com/OSGeo/homebrew-osgeo4mac" target="_blank" rel="external">Github</a><br>Also if you need the python bindings afterward, try:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/opt/gdal-20/bin</div><div class="line"><span class="built_in">export</span> LDFLAGS=-L/usr/<span class="built_in">local</span>/opt/gdal-20/lib</div><div class="line"><span class="built_in">export</span> CPPFLAGS=-I/usr/<span class="built_in">local</span>/opt/gdal-20/include</div><div class="line">pip install gdal</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/18/Problems-sending-email-through-celery/" itemprop="url">
                  Problems sending email through celery
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-18T08:12:00+08:00" content="2016-09-18">
              2016-09-18
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/18/Problems-sending-email-through-celery/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/18/Problems-sending-email-through-celery/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/18/Problems-sending-email-through-celery/" class="leancloud_visitors" data-flag-title="Problems sending email through celery">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="versions"><a href="#versions" class="headerlink" title="versions"></a>versions</h3><p>python 3.5</p>
<p>celery 3.1.23</p>
<h3 id="task"><a href="#task" class="headerlink" title="task"></a>task</h3><p>It will be nice that we could get email notification whenever a celery task fails. </p>
<p>There’s some built in email setting in Celery 3 through <a href="http://docs.celeryproject.org/en/latest/configuration.html" target="_blank" rel="external">configuration</a>.</p>
<p>Following are sample configuration from the document:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Enables error emails.</span></div><div class="line">CELERY_SEND_TASK_ERROR_EMAILS = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="comment"># Name and email addresses of recipients</span></div><div class="line">ADMINS = (</div><div class="line">    (<span class="string">'George Costanza'</span>, <span class="string">'george@vandelay.com'</span>),</div><div class="line">    (<span class="string">'Cosmo Kramer'</span>, <span class="string">'kosmo@vandelay.com'</span>),</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment"># Email address used as sender (From field).</span></div><div class="line">SERVER_EMAIL = <span class="string">'no-reply@vandelay.com'</span></div><div class="line"></div><div class="line"><span class="comment"># Mailserver configuration</span></div><div class="line">EMAIL_HOST = <span class="string">'mail.vandelay.com'</span></div><div class="line">EMAIL_PORT = <span class="number">25</span></div><div class="line"><span class="comment"># EMAIL_HOST_USER = 'servers'</span></div><div class="line"><span class="comment"># EMAIL_HOST_PASSWORD = 's3cr3t'</span></div></pre></td></tr></table></figure></p>
<h3 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h3><p>However there’s a problem for small tasks.</p>
<p>The email sent by celery is sync which adds up the finish time for the task. Supposed it sends the email in 1s and your task fails in 10ms, this makes your task total run time up to 1.01s. It’s fine if you use it in long running task or trivil background job. However it’s completely unacceptable if you are using it for time critical jobs.</p>
<p>Also this functionality is removed in up coming 4.0</p>
<p><a href="http://docs.celeryproject.org/en/master/whatsnew-4.0.html#features-removed-for-simplicity" target="_blank" rel="external">http://docs.celeryproject.org/en/master/whatsnew-4.0.html#features-removed-for-simplicity</a></p>
<h3 id="solution"><a href="#solution" class="headerlink" title="solution"></a>solution</h3><p>Obviously we need a way to handle this. using the <strong><em>link_error</em></strong> parameter in <strong><em>async_task</em></strong> may be a solution for single task. I’ll update the post when I have time to write some general async error email notification solution</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/16/some-open-source-projects/" itemprop="url">
                  some open source projects
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-16T16:55:00+08:00" content="2016-09-16">
              2016-09-16
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/16/some-open-source-projects/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/16/some-open-source-projects/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/16/some-open-source-projects/" class="leancloud_visitors" data-flag-title="some open source projects">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">visitors </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一些开源的小项目"><a href="#一些开源的小项目" class="headerlink" title="一些开源的小项目"></a>一些开源的小项目</h1><p>下列是我在幸福西饼工作期间不涉及业务层面的代码（我作为main author)，分享给大家,鉴于已经离开，所有没业务需求的话，应该很少更新了。</p>
<ul>
<li><img src="https://img.shields.io/npm/dt/pingpp-verifier.svg" class="inline-image"> <img src="https://img.shields.io/npm/v/pingpp-verifier.svg" class="inline-image"> <a href="https://github.com/MadHouses/pingpp-verifier" target="_blank" rel="external">Ping++ webhook 签名插件（Nodejs）</a></li>
<li><img src="https://img.shields.io/npm/dt/deo-youzan.svg" class="inline-image"> <img src="https://img.shields.io/npm/v/deo-youzan.svg" class="inline-image"> <a href="https://github.com/MadHouses/youzan" target="_blank" rel="external">有赞API SDK（Nodejs）</a></li>
<li><img src="https://img.shields.io/npm/dt/baidu_map.svg" class="inline-image"> <img src="https://img.shields.io/npm/v/baidu_map.svg" class="inline-image"> <a href="https://github.com/MadHouses/baidu_map" target="_blank" rel="external">百度地图API SDK（Nodejs）</a></li>
</ul>
<p>还有团队的一些开源贡献</p>
<ul>
<li><img src="https://img.shields.io/npm/dt/taobao-openapi.svg" class="inline-image"> <img src="https://img.shields.io/npm/v/taobao-openapi.svg" class="inline-image"> <a href="https://github.com/MadHouses/taobao-openapi" target="_blank" rel="external">淘宝API SDK（Nodejs）</a></li>
<li><img src="https://img.shields.io/npm/dt/meituan.svg" class="inline-image"> <img src="https://img.shields.io/npm/v/meituan.svg" class="inline-image"> <a href="https://github.com/MadHouses/meituan" target="_blank" rel="external">美团外卖 SDK（Nodejs）</a></li>
<li><img src="https://img.shields.io/npm/dt/mysql-express-session.svg" class="inline-image"> <img src="https://img.shields.io/npm/v/mysql-express-session.svg" class="inline-image"> <a href="https://github.com/MadHouses/mysql-express-session" target="_blank" rel="external">Express session using MySQL（Nodejs）</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpeg"
               alt="Zhanzhao Deo Liang" />
          <p class="site-author-name" itemprop="name">Zhanzhao Deo Liang</p>
          <p class="site-description motion-element" itemprop="description">专业救火，专职刷脸，价格公道，值得拥有</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/DeoLeung" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://cn.linkedin.com/in/zhanzhao-liang-3aba6435" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin-square"></i>
                  
                  Linkedin
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhanzhao Deo Liang</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"deoim"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("al7vfe5uM3puAgJWG6PqmYVd-gzGzoHsz", "IIbhS1VihnVTRgon9k1b1715");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
